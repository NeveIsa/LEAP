<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select an Experiment</title>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Unique landing theme (not shared with any experiment) -->
    <style>
        :root {
            --lp-bg: radial-gradient(1200px 800px at 10% 10%, #0f172a 0%, #0b1022 28%, #070b19 60%, #060915 100%);
            --lp-ink: #e6e9f5;
            --lp-muted: #9aa3b2;
            --lp-card: rgba(22, 28, 45, 0.72);
            --lp-border: rgba(148, 163, 184, 0.18);
            --lp-accent: #a78bfa; /* violet */
            --lp-accent-2: #f472b6; /* pink */
            --lp-good: #7ef29a;
        }
        * { box-sizing: border-box }
        html, body { height: 100%; }
        body {
            margin: 0;
            padding: 0;
            background: var(--lp-bg);
            color: var(--lp-ink);
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
        }
        .page-centered { display: grid; place-items: center; padding: 32px 16px; }
        .dashboard-container {
            width: min(920px, 95vw);
            background: var(--lp-card);
            border: 1px solid var(--lp-border);
            border-radius: 16px;
            padding: 22px 22px 18px;
            box-shadow: 0 20px 40px rgba(2, 6, 23, 0.45), inset 0 1px 0 rgba(255,255,255,0.04);
            backdrop-filter: blur(10px);
        }
        h1 { margin: 0 0 6px 0; font-size: 26px; letter-spacing: 0.2px; }
        p { margin: 6px 0; color: var(--lp-muted); }
        .text-muted { color: var(--lp-muted); }

        .table-wrap { margin-top: 14px; border: 1px solid var(--lp-border); border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: rgba(167, 139, 250, 0.08); }
        th, td { text-align: left; padding: 12px 14px; border-bottom: 1px solid var(--lp-border); }
        tbody tr:hover { background: rgba(244, 114, 182, 0.06); transition: background 160ms ease; }

        .toolbar { margin-top: 12px; }
        .badge { display: inline-block; padding: 6px 10px; border-radius: 999px; font-weight: 600; background: linear-gradient(135deg, rgba(167,139,250,0.18), rgba(244,114,182,0.18)); border: 1px solid var(--lp-border); color: var(--lp-ink); }
        /* Normalize button/link buttons to identical size */
        .btn { 
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            height: 36px; padding: 0 12px; font-size: 14px; line-height: 1; font-weight: 700;
            border-radius: 10px; border: 0; cursor: pointer; text-decoration: none;
            color: #0b1022; background: linear-gradient(135deg, var(--lp-accent), var(--lp-accent-2));
            box-shadow: 0 6px 14px rgba(167,139,250,0.22);
        }
        button.btn { appearance: none; -webkit-appearance: none; border: 0; }
        a.btn { color: #0b1022; text-decoration: none; }
        .btn[disabled], .btn[aria-disabled="true"] { opacity: .55; cursor: not-allowed; }

        /* Make the status chip pop when active */
        .status-active { color:#0b1022; background:#34f5c5; }

        /* Subtle pulse for active badge */
        @keyframes pulseGlow { 0%{box-shadow:0 0 0 0 rgba(167,139,250,.4)} 70%{box-shadow:0 0 0 8px rgba(167,139,250,0)} 100%{box-shadow:0 0 0 0 rgba(167,139,250,0)} }
        .pulse { animation: pulseGlow 2.2s ease-out infinite; }

        /* Minimal logo mark */
        .lp-logo { width:28px; height:28px; border-radius:8px; background: conic-gradient(from 210deg, var(--lp-accent), var(--lp-accent-2)); box-shadow: 0 6px 14px rgba(167,139,250,0.28), inset 0 1px 0 rgba(255,255,255,.18); }

        /* Polished login modal */
        .lp-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(2, 6, 23, 0.6); backdrop-filter: blur(6px); z-index: 1000; }
        .lp-dialog { width: min(520px, 94vw); background: var(--lp-card); border: 1px solid var(--lp-border); border-radius: 14px; padding: 18px; box-shadow: 0 20px 40px rgba(2, 6, 23, 0.45), inset 0 1px 0 rgba(255,255,255,0.04); }
        .lp-head { display:flex; align-items:center; gap:10px; margin-bottom: 12px; }
        .lp-head .lp-logo { width:22px; height:22px; border-radius:6px; }
        .lp-head h3 { margin:0; font-size:18px; letter-spacing:.2px; }
        .lp-head .badge { font-size:12px; padding:4px 8px; }
        .lp-form { display:flex; flex-direction:column; gap:10px; }
        .lp-label { font-size:13px; color: var(--lp-muted); }
        .lp-input { width:100%; height:38px; padding: 0 10px; border-radius:10px; border:1px solid var(--lp-border); background:#0f1427; color: var(--lp-ink); outline:none; }
        .lp-input:focus { border-color: rgba(167,139,250,0.55); box-shadow: 0 0 0 3px rgba(167,139,250,0.18); }
        .lp-actions { display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top: 4px; }
        .lp-error { color:#ff6b6b; flex:1; text-align:left; font-size:13px; }

        /* Keep table text left-aligned */
        .dashboard-container table th,
        .dashboard-container table td { text-align: left; }
        /* Keep primary action (Launch/Stop) width consistent regardless of label */
        .table-wrap td:last-child button.btn { min-width: 96px; }
    </style>
</head>
<body class="page-centered">
    <div class="dashboard-container">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:6px;">
            <div class="lp-logo" aria-hidden="true"></div>
            <h1 style="margin:0;">Select an Experiment</h1>
        </div>
        <p>The following experiments are available. Only one can be active at a time.</p>
        <p class="text-muted" style="margin-top:-6px">Clients call root APIs and must include <code>experiment_name</code> that matches the currently active experiment; requests for other experiments are rejected.</p>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Experiment</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="exp-table-body">
                    <!-- Populated by script -->
                </tbody>
            </table>
        </div>
        <div class="toolbar" style="margin-top:16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <span class="badge" id="active-badge">Active: â€¦</span>
            <span class="badge" id="auth-badge">Logged in for: none</span>
            <span id="lock-note" class="text-muted" style="display:none; font-size:13px;">Stop the active experiment to launch another.</span>
            <div style="flex:1"></div>
            <button class="btn" id="refresh">Refresh</button>
        </div>
    </div>

    <script>
        async function fetchJSON(url, options={}) {
            const res = await fetch(url, { credentials: 'include', ...options });
            if (!res.ok) {
                const err = new Error(`${res.status}`);
                err.status = res.status;
                try {
                    err.detail = (await res.json()).detail;
                } catch (_) {}
                throw err;
            }
            return res.json();
        }

        async function refreshExperiments() {
            const tbody = document.getElementById('exp-table-body');
            const activeBadge = document.getElementById('active-badge');
            const authBadge = document.getElementById('auth-badge');
            const lockNote = document.getElementById('lock-note');
            tbody.innerHTML = '';
            try {
                const [experiments, activeObj, authObj] = await Promise.all([
                    fetchJSON('/api/experiments'),
                    fetchJSON('/api/active-experiment').catch(() => ({ active: null })),
                    fetchJSON('/api/auth-experiments').catch(() => ({ auth: [] })),
                ]);
                const active = activeObj && typeof activeObj === 'object' ? activeObj.active : null;
                activeBadge.textContent = `Active: ${active || 'none'}`;
                activeBadge.classList.toggle('pulse', !!active);
                lockNote.style.display = active ? '' : 'none';
                const authList = Array.isArray(authObj?.auth) ? authObj.auth : [];
                authBadge.textContent = `Logged in for: ${authList.length ? authList.join(', ') : 'none'}`;
                if (!Array.isArray(experiments) || experiments.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="3" style="text-align:center;">No experiments found.</td>`;
                    tbody.appendChild(tr);
                    return;
                }
                for (const exp of experiments) {
                    const tr = document.createElement('tr');
                    const isActive = active === exp;
                    const status = isActive ? '<span class="badge" style="color:#1a1a1a;background:#00f5d4;">Active</span>' : '';
                    const buttonDisabled = (active && !isActive);
                    // Open UI should only be clickable when this experiment is active
                    const linkDisabledAttr = (!isActive) ? 'aria-disabled="true" tabindex="-1" style="opacity:0.5;pointer-events:none;"' : '';
                    const actionLabel = isActive ? 'Stop' : 'Launch';
                    const disabledAttrs = buttonDisabled ? 'disabled aria-disabled="true" style="opacity:0.6;pointer-events:none;" title="Stop the active experiment to launch another"' : '';
                    tr.innerHTML = `
                        <td><strong>${exp}</strong></td>
                        <td>${status}</td>
                        <td>
                            <button class="btn" data-exp="${exp}" data-action="${isActive ? 'stop' : 'start'}" ${disabledAttrs}>${actionLabel}</button>
                            <a class="btn" href="/exp/${exp}/ui/dashboard.html" target="_blank" rel="noopener noreferrer" ${linkDisabledAttr}>Open UI</a>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            } catch (error) {
                console.error('Error fetching experiments/active:', error);
                tbody.innerHTML = `<tr><td colspan="3" style="color:red; text-align:center;">Could not load experiments. Is the server running?</td></tr>`;
            }
        }

        async function handleAction(action, name, _retry=false) {
            try {
                if (action === 'start') {
                    await fetchJSON('/api/experiments/start', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name })
                    });
                } else if (action === 'stop') {
                    await fetchJSON('/api/experiments/stop', { method: 'POST' });
                }
                await refreshExperiments();
            } catch (e) {
                if (e && e.status === 401 && !_retry) {
                    const ok = await showLoginModal(name);
                    if (ok) return handleAction(action, name, true);
                    return; // user canceled
                }
                alert(`Action failed: ${e.detail || e.message || e}`);
            }
        }

        // --- Inline Login Modal ---
        function showLoginModal(expName) {
            return new Promise((resolve) => {
                const modal = ensureLoginModal();
                const form = modal.querySelector('form');
                const btnClose = modal.querySelector('[data-close]');
                const errBox = modal.querySelector('[data-error]');
                errBox.textContent = '';
                modal.style.display = 'flex';

                const onClose = () => {
                    cleanup();
                    modal.style.display = 'none';
                    resolve(false);
                };
                btnClose.onclick = onClose;
                modal.onclick = (ev) => { if (ev.target === modal) onClose(); };

                // Set target experiment name in the modal header badge
                const expBadge = modal.querySelector('#lp-exp-badge');
                if (expBadge) expBadge.textContent = expName || 'unknown';

                const onSubmit = async (ev) => {
                    ev.preventDefault();
                    errBox.textContent = '';
                    const username = form.querySelector('input[name="username"]').value.trim();
                    const password = form.querySelector('input[name="password"]').value.trim();
                    try {
                        // Authenticate against the target experiment's admin
                        const res = await fetch(`/exp/${expName}/admin/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ username, password })
                        });
                        if (!res.ok) {
                            let detail = 'Login failed';
                            try { detail = (await res.json()).detail || detail; } catch {}
                            errBox.textContent = detail;
                            return;
                        }
                        cleanup();
                        modal.style.display = 'none';
                        resolve(true);
                    } catch (err) {
                        errBox.textContent = 'Network error. Try again.';
                    }
                };
                form.addEventListener('submit', onSubmit);

                function cleanup() {
                    form.removeEventListener('submit', onSubmit);
                    btnClose.onclick = null;
                    modal.onclick = null;
                }
            });
        }

        function ensureLoginModal() {
            let modal = document.getElementById('login-modal');
            if (modal) return modal;
            modal = document.createElement('div');
            modal.id = 'login-modal';
            modal.className = 'lp-modal';
            modal.innerHTML = [
                '<div class="lp-dialog">',
                '  <div class="lp-head">',
                '    <div class="lp-logo" aria-hidden="true"></div>',
                '    <h3>Admin Login</h3>',
                '    <span class="badge" id="lp-exp-badge">&nbsp;</span>',
                '  </div>',
                '  <form class="lp-form">',
                '    <label class="lp-label" for="lp-username">Username</label>',
                '    <input class="lp-input" id="lp-username" type="text" name="username" value="admin" autocomplete="username" />',
                '    <label class="lp-label" for="lp-password">Password</label>',
                '    <input class="lp-input" id="lp-password" type="password" name="password" value="password" autocomplete="current-password" />',
                '    <div class="lp-actions">',
                '      <span data-error class="lp-error"></span>',
                '      <button type="button" class="btn ghost" data-close>Cancel</button>',
                '      <button type="submit" class="btn">Login</button>',
                '    </div>',
                '  </form>',
                '</div>'
            ].join('\n');
            document.body.appendChild(modal);
            return modal;
        }

        document.addEventListener('DOMContentLoaded', refreshExperiments);
        document.getElementById('refresh').addEventListener('click', refreshExperiments);
        document.addEventListener('click', (ev) => {
            const btn = ev.target.closest('button.btn[data-action][data-exp]');
            if (!btn) return;
            if (btn.hasAttribute('disabled')) return; // ignore disabled
            ev.preventDefault();
            const action = btn.getAttribute('data-action');
            const name = btn.getAttribute('data-exp');
            handleAction(action, name);
        });
    </script>
</body>
</html>
