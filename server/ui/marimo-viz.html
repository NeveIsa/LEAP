<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marimo Log Visualization</title>
    <link rel="stylesheet" href="style/main.css" />
    <script src="https://cdn.jsdelivr.net/npm/@marimo-team/marimo-snippets@1"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
        }
        .back-btn:hover {
            background: #545b62;
        }
        .notebook-section {
            margin-bottom: 40px;
        }
        .notebook-title {
            color: #e0e0e0;
            margin-bottom: 20px;
            font-size: 24px;
        }
    </style>
</head>
<body class="page-centered">
    <div class="container">
        <div class="header">
            <h1 style="margin:0; color: #e0e0e0;">Marimo Log Visualization</h1>
            <a href="dashboard.html" class="back-btn">Back to Dashboard</a>
        </div>

        <div class="notebook-section">
            <h2 class="notebook-title">Test Notebook - Simple Scatter Plot</h2>
            <marimo-iframe data-theme="dark" data-height="600px">
                <pre><code class="language-python">import marimo as mo
import requests as req
import seaborn as sns
import matplotlib.pyplot as plt</code></pre>
                
                <pre><code class="language-python"># Fetch logs from your server
logs = req.get("http://localhost:9000/logs?sid=s001&exp=eigen").json()["logs"]
print(f"Fetched {len(logs)} logs")</code></pre>
                
                <pre><code class="language-python"># Transform logs to extract x,y coordinates
def transform(logs):
    x, y = [], []
    for log in logs:
        if log.get("result_json"):
            try:
                result = log["result_json"]
                if isinstance(result, str):
                    import json
                    result = json.loads(result)
                if isinstance(result, list) and len(result) >= 2:
                    x.append(result[0])
                    y.append(result[1])
            except:
                continue
    return x, y

x, y = transform(logs)
print(f"Extracted {len(x)} data points")</code></pre>
                
                <pre><code class="language-python"># Create scatter plot
if len(x) > 0:
    plt.figure(figsize=(10, 6))
    plt.style.use('dark_background')
    sns.scatterplot(x=x, y=y, alpha=0.7)
    plt.title('Log Data Scatter Plot', color='white')
    plt.xlabel('X Coordinate', color='white')
    plt.ylabel('Y Coordinate', color='white')
    plt.grid(True, alpha=0.3)
    plt.show()
else:
    print("No data points to plot")</code></pre>
            </marimo-iframe>
        </div>

        <div class="notebook-section">
            <h2 class="notebook-title">Interactive Slider Example</h2>
            <marimo-iframe data-theme="dark" data-height="400px">
                <pre><code class="language-python">import marimo as mo
import numpy as np
import matplotlib.pyplot as plt</code></pre>
                
                <pre><code class="language-python"># Create an interactive slider
slider = mo.ui.slider(1, 10, value=5)
slider</code></pre>
                
                <pre><code class="language-python"># Use the slider value to create a plot
plt.figure(figsize=(10, 6))
plt.style.use('dark_background')
x = np.linspace(0, 10, 100)
y = np.sin(x * slider.value)
plt.plot(x, y, linewidth=2)
plt.title(f'Sine Wave with Frequency {slider.value}', color='white')
plt.xlabel('X', color='white')
plt.ylabel('Y', color='white')
plt.grid(True, alpha=0.3)
plt.show()</code></pre>
            </marimo-iframe>
        </div>

        <div class="notebook-section">
            <h2 class="notebook-title">Log Analysis Dashboard</h2>
            <marimo-iframe data-theme="dark" data-height="800px">
                <pre><code class="language-python">import marimo as mo
import requests
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import json</code></pre>
                
                <pre><code class="language-python"># Configuration
config = {
    "api_base": "http://localhost:9000",
    "default_student": "s001",
    "default_experiment": "eigen"
}</code></pre>
                
                <pre><code class="language-python"># Fetch logs from API
def fetch_logs(student_id=None, experiment_name=None, n=100):
    params = {}
    if student_id:
        params['sid'] = student_id
    if experiment_name:
        params['exp'] = experiment_name
    params['n'] = n
    
    try:
        response = requests.get(f"{config['api_base']}/logs", params=params)
        if response.status_code == 200:
            return response.json()["logs"]
        else:
            print(f"Error fetching logs: {response.status_code}")
            return []
    except Exception as e:
        print(f"Error fetching logs: {e}")
        return []

# Fetch logs
logs = fetch_logs(
    student_id=config["default_student"],
    experiment_name=config["default_experiment"]
)
print(f"Fetched {len(logs)} logs")</code></pre>
                
                <pre><code class="language-python"># Transform logs to DataFrame
def transform_logs(logs):
    data = []
    for log in logs:
        try:
            result = None
            if log.get("result_json"):
                result = json.loads(log["result_json"])
            
            data.append({
                "timestamp": log.get("timestamp"),
                "student_id": log.get("student_id"),
                "experiment": log.get("experiment_name"),
                "function": log.get("func_name"),
                "args": log.get("args_json"),
                "result": result,
                "error": log.get("error"),
                "success": log.get("error") is None
            })
        except Exception as e:
            print(f"Error processing log: {e}")
            continue
    
    return pd.DataFrame(data)

df = transform_logs(logs)
print(f"Transformed {len(df)} logs into DataFrame")</code></pre>
                
                <pre><code class="language-python"># Display statistics
if not df.empty:
    print("=== Log Statistics ===")
    print(f"Total logs: {len(df)}")
    print(f"Successful executions: {df['success'].sum()}")
    print(f"Failed executions: {len(df) - df['success'].sum()}")
    print(f"Unique students: {df['student_id'].nunique()}")
    print(f"Unique experiments: {df['experiment'].nunique()}")
    print(f"Unique functions: {df['function'].nunique()}")
    
    print("\n=== Function Usage ===")
    function_counts = df['function'].value_counts()
    print(function_counts)
else:
    print("No data to display")</code></pre>
                
                <pre><code class="language-python"># Create visualizations
if not df.empty:
    plt.style.use('dark_background')
    sns.set_palette("husl")
    
    fig, axes = plt.subplots(2, 2, figsize=(12, 10))
    fig.suptitle('Log Analysis Dashboard', fontsize=16, color='white')
    
    # Success vs Failure pie chart
    if len(df) > 0:
        success_counts = df['success'].value_counts()
        axes[0, 0].pie(success_counts.values, 
                      labels=['Failed' if not x else 'Success' for x in success_counts.index], 
                      autopct='%1.1f%%', startangle=90)
        axes[0, 0].set_title('Success vs Failure Rate', color='white')
    
    # Function usage bar chart
    if df['function'].nunique() > 0:
        function_counts = df['function'].value_counts().head(10)
        axes[0, 1].bar(range(len(function_counts)), function_counts.values)
        axes[0, 1].set_xticks(range(len(function_counts)))
        axes[0, 1].set_xticklabels(function_counts.index, rotation=45, ha='right')
        axes[0, 1].set_title('Most Used Functions', color='white')
        axes[0, 1].set_ylabel('Count', color='white')
        axes[0, 1].tick_params(colors='white')
    
    # Timeline of executions
    if 'timestamp' in df.columns and not df['timestamp'].isna().all():
        df['timestamp'] = pd.to_datetime(df['timestamp'])
        df_sorted = df.sort_values('timestamp')
        axes[1, 0].plot(df_sorted['timestamp'], range(len(df_sorted)), marker='o', markersize=2)
        axes[1, 0].set_title('Execution Timeline', color='white')
        axes[1, 0].set_xlabel('Time', color='white')
        axes[1, 0].set_ylabel('Log Index', color='white')
        axes[1, 0].tick_params(axis='x', rotation=45, colors='white')
    
    # Student activity
    if df['student_id'].nunique() > 0:
        student_counts = df['student_id'].value_counts().head(10)
        axes[1, 1].bar(range(len(student_counts)), student_counts.values)
        axes[1, 1].set_xticks(range(len(student_counts)))
        axes[1, 1].set_xticklabels(student_counts.index, rotation=45, ha='right')
        axes[1, 1].set_title('Student Activity', color='white')
        axes[1, 1].set_ylabel('Log Count', color='white')
        axes[1, 1].tick_params(colors='white')
    
    plt.tight_layout()
    plt.show()
else:
    print("No data to visualize")</code></pre>
            </marimo-iframe>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;

        // Require authentication to view dashboard
        (async () => {
            try {
                const resp = await fetch(`${API_BASE_URL}/admin/ping`, { credentials: 'include' });
                if (!resp.ok) {
                    window.location.href = 'login.html';
                }
            } catch (e) {
                window.location.href = 'login.html';
            }
        })();
    </script>
</body>
</html>
