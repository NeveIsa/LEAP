<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Logs</title>
  <link rel="stylesheet" href="style/main.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>Logs</h1>
      <span class="subtle">Last 100 entries</span>
      <span class="badge" id="exp-scope" style="float:right">Scope: …</span>
    </header>

    <div class="toolbar" style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
      <a href="dashboard.html">← Back</a>
      <div style="flex:1"></div>
      <label for="studentSelect">Student:</label>
      <select id="studentSelect" class="input">
        <option value="">All</option>
      </select>
      <label for="expSelect">Trial:</label>
      <select id="expSelect" class="input">
        <option value="">All</option>
      </select>
      <button class="btn" id="filterBtn">Filter</button>
      <button class="btn" id="refreshBtn">Clear</button>
      <span class="badge" id="countBadge">Loading…</span>
      <span class="badge" id="updatedBadge"></span>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Student</th>
            <th>Trial</th>
            <th>Function</th>
            <th>Args</th>
            <th>Result</th>
            <th>Error</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>

    <div class="footer" id="message"></div>
  </div>

  <script>
    const API_BASE_URL = window.location.origin;
    const expMatch = window.location.pathname.match(/\/exp\/([^\/]+)/);
    const expPrefix = expMatch ? `/exp/${expMatch[1]}` : '';

    const logBody = document.getElementById('logBody');
    const countBadge = document.getElementById('countBadge');
    const updatedBadge = document.getElementById('updatedBadge');
    const msg = document.getElementById('message');
    const studentSelect = document.getElementById('studentSelect');
    const expSelect = document.getElementById('expSelect');
    const QS = new URLSearchParams(window.location.search);
    const QS_SID = QS.get('sid') || QS.get('student_id') || '';
    const QS_EXP = QS.get('trial') || QS.get('trial_name') || QS.get('exp') || QS.get('experiment_name') || '';
    document.getElementById('exp-scope').textContent = `Scope: ${expMatch ? expMatch[1] : 'root'}`;

    function setMsg(text) { msg.textContent = text || ''; }

    async function fetchLogs(studentId, experimentNameFilter) {
      try {
        const params = new URLSearchParams({ n: 100, order: 'latest' });
        if (studentId) params.set('student_id', studentId);
        if (experimentNameFilter) params.set('trial', experimentNameFilter);
        const res = await fetch(`${API_BASE_URL}${expPrefix}/logs?${params.toString()}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        return data.logs || [];
      } catch (e) {
        console.error('Fetch logs failed', e);
        if (String(e).includes('HTTP 409')) {
          setMsg('No active experiment. Start one from the landing page.');
        } else {
          setMsg('Failed to fetch logs. Is the server running?');
        }
        return [];
      }
    }

    function uniqueSorted(arr) {
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b) => a < b ? -1 : a > b ? 1 : 0);
    }

    function populateSelect(sel, values) {
      sel.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '';
      optAll.textContent = 'All';
      sel.appendChild(optAll);
      for (const v of values) {
        const o = document.createElement('option');
        o.value = v;
        o.textContent = v;
        sel.appendChild(o);
      }
    }

    function renderLogs(logs) {
      logBody.innerHTML = '';
      if (!logs.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.textContent = 'No logs available.';
        tr.appendChild(td);
        logBody.appendChild(tr);
        return;
      }

      for (const row of logs) {
        const tr = document.createElement('tr');
        const tds = [
          new Date(row.ts).toLocaleString([], { hour12: false, year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' }),
          row.student_id || '',
          row.experiment_name || '',
          row.func_name || '',
          row.args_json || '',
          row.result_json || '',
          row.error || ''
        ];

        tds.forEach((val, i) => {
          const td = document.createElement('td');
          td.className = i <= 3 ? 'min' : 'code';
          td.textContent = typeof val === 'string' ? val : String(val);
          tr.appendChild(td);
        });

        logBody.appendChild(tr);
      }
    }

    function updateUrlParams(sid, exp) {
      const url = new URL(window.location.href);
      if (sid) url.searchParams.set('sid', sid); else url.searchParams.delete('sid');
      if (exp) url.searchParams.set('exp', exp); else url.searchParams.delete('exp');
      history.replaceState(null, '', url);
    }

    async function refresh() {
      setMsg('');
      countBadge.textContent = 'Loading…';
      const studentId = studentSelect.value;
      const experimentName = expSelect.value;
      updateUrlParams(studentId, experimentName);
      const logs = await fetchLogs(studentId, experimentName);
      renderLogs(logs);
      countBadge.textContent = `${logs.length} logs`;
      updatedBadge.textContent = `Updated ${new Date().toLocaleTimeString()}`;
    }

    document.getElementById('filterBtn').addEventListener('click', refresh);
    document.getElementById('refreshBtn').addEventListener('click', () => {
        studentSelect.value = '';
        expSelect.value = '';
        refresh();
    });
    document.addEventListener('DOMContentLoaded', async () => {
      const seedLogs = await fetchLogs('', '');
      const students = uniqueSorted(seedLogs.map(l => l.student_id));
      const exps = uniqueSorted(seedLogs.map(l => l.experiment_name));
      populateSelect(studentSelect, students);
      populateSelect(expSelect, exps);
      if (QS_SID) studentSelect.value = QS_SID;
      if (QS_EXP) expSelect.value = QS_EXP;
      refresh();
    });
  </script>
</body>
</html>
