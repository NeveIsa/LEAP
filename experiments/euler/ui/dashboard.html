<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Euler's Method Dashboard</title>
    <link rel="stylesheet" href="style/main.css" />
</head>
<body class="page-centered">
    <div class="dashboard-container">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <a href="/" class="btn">← Experiments</a>
                <h1 style="margin:0;">Euler's Method Dashboard</h1>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span class="badge" id="active-badge">Active: …</span>
                <span class="badge" id="auth-badge">Auth: …</span>
                <button id="login-btn" class="btn" title="Login for management actions">Login</button>
                <button id="logout-btn" class="btn">Logout</button>
            </div>
        </div>
        <div class="links-grid">
            <a href="students.html" class="dashboard-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                Students
            </a>
            <a href="logs.html" class="dashboard-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 5h18v2H3V5zm0 6h18v2H3v-2zm0 6h18v2H3v-2z"/></svg>
                Logs List
            </a>
            <a href="euler-learning.html" class="dashboard-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                Learn Euler's Method
            </a>
            <a href="euler-demo.html" class="dashboard-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/></svg>
                Euler Demo
            </a>
            <a href="function-reference.html" class="dashboard-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                Function Reference
            </a>
        </div>

        <div style="margin-top:20px; border:1px solid var(--border-color); border-radius:10px; padding:14px; background: var(--surface-color);">
            <h2 style="margin:0 0 8px 0; font-size:18px;">Euler's Method Activity (last 50)</h2>
            <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
                <div style="display:flex; align-items:center; gap:6px;">
                    <label for="k-trial" class="subtle">Trial</label>
                    <select id="k-trial" class="input" style="padding:6px 8px; background:#121826; color:#e5e7eb; border:1px solid var(--border-color); border-radius:8px;">
                        <option value="">All</option>
                    </select>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="badge" id="k-logs">0</span>
                    <span class="subtle">logs</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="badge" id="k-students">0</span>
                    <span class="subtle">students</span>
                </div>
                <div class="subtle" id="k-upd">—</div>
            </div>
            <div class="spark-wrap">
                <canvas id="k-spark" width="360" height="48" class="spark-canvas"></canvas>
            </div>
        </div>

        <div style="margin-top:20px; border:1px solid var(--border-color); border-radius:10px; padding:14px; background: var(--surface-color);">
            <h2 style="margin:0 0 8px 0; font-size:18px;">Available Functions</h2>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:12px; margin-top:12px;">
                <div class="card">
                    <h3 style="margin:0 0 8px 0; color:var(--primary-color);">Basic Euler Method</h3>
                    <p style="margin:0; font-size:14px; color:var(--muted-color);">euler_method(f, y0, t0, h, n_steps)</p>
                </div>
                <div class="card">
                    <h3 style="margin:0 0 8px 0; color:var(--primary-color);">Exponential Growth</h3>
                    <p style="margin:0; font-size:14px; color:var(--muted-color);">solve_exponential_growth(y0, t0, h, n_steps)</p>
                </div>
                <div class="card">
                    <h3 style="margin:0 0 8px 0; color:var(--primary-color);">Exponential Decay</h3>
                    <p style="margin:0; font-size:14px; color:var(--muted-color);">solve_exponential_decay(y0, t0, h, n_steps)</p>
                </div>
                <div class="card">
                    <h3 style="margin:0 0 8px 0; color:var(--primary-color);">Logistic Growth</h3>
                    <p style="margin:0; font-size:14px; color:var(--muted-color);">solve_logistic_growth(y0, t0, h, n_steps, r, K)</p>
                </div>
                <div class="card">
                    <h3 style="margin:0 0 8px 0; color:var(--primary-color);">Harmonic Oscillator</h3>
                    <p style="margin:0; font-size:14px; color:var(--muted-color);">solve_harmonic_oscillator(y0, t0, h, n_steps, omega)</p>
                </div>
                <div class="card">
                    <h3 style="margin:0 0 8px 0; color:var(--primary-color);">Population with Predation</h3>
                    <p style="margin:0; font-size:14px; color:var(--muted-color);">solve_population_predation(y0, t0, h, n_steps, r, a)</p>
                </div>
            </div>
        </div>
    </div>

  <script>
        const API_BASE_URL = window.location.origin;
        const expMatch = window.location.pathname.match(/\/exp\/([^\/]+)/);
        const expPrefix = '';
        async function refreshActive(){
            try{ const r=await fetch(`${API_BASE_URL}/api/active-experiment`); const d=await r.json(); document.getElementById('active-badge').textContent=`Active: ${d.active || 'none'}`; }catch{ document.getElementById('active-badge').textContent='Active: ?'; }
        }

        const authBadge = document.getElementById('auth-badge');
        async function refreshAuth() {
            try {
                const resp = await fetch(`${API_BASE_URL}/admin/ping`, { credentials: 'include' });
                const loggedIn = resp.ok;
                authBadge.textContent = loggedIn ? 'Auth: logged in' : 'Auth: logged out';
                loginBtn.style.display = loggedIn ? 'none' : '';
                logoutBtn.style.display = loggedIn ? '' : 'none';
            } catch (e) {
                authBadge.textContent = 'Auth: logged out';
                loginBtn.style.display = '';
                logoutBtn.style.display = 'none';
            }
        }

        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        loginBtn?.addEventListener('click', () => { window.location.href = 'login.html'; });
        logoutBtn?.addEventListener('click', async () => {
            try { await fetch(`${API_BASE_URL}/admin/logout`, { method: 'POST', credentials: 'include' }); } catch (e) {}
            await refreshAuth();
        });

        function drawSpark(logs){
            const cvs = document.getElementById('k-spark'); if(!cvs) return; const ctx=cvs.getContext('2d');
            const W=cvs.width, H=cvs.height; ctx.clearRect(0,0,W,H);
            const cs = getComputedStyle(document.documentElement);
            const baseColor = cs.getPropertyValue('--border-color').trim() || '#233';
            const strokeColor = cs.getPropertyValue('--primary-color').trim() || '#00f5d4';
            const now=Date.now(), win=10*60*1000, start=now-win, buckets=20, step=win/buckets;
            const counts = new Array(buckets).fill(0);
            for(const row of logs){ const t=Date.parse(row.ts||'')||0; if(t<start) continue; const idx=Math.min(buckets-1, Math.max(0, Math.floor((t-start)/step))); counts[idx]++; }
            const maxV=Math.max(1,...counts);
            ctx.strokeStyle=baseColor; ctx.beginPath(); ctx.moveTo(0,H-1); ctx.lineTo(W,H-1); ctx.stroke();
            ctx.strokeStyle=strokeColor; ctx.lineWidth=2; ctx.beginPath();
            for(let i=0;i<buckets;i++){ const x=(i/(buckets-1))*W; const y=H-2-(counts[i]/maxV)*(H-6); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
            ctx.stroke();
        }

        async function loadTrialOptions(){
            try {
                const res = await fetch(`${API_BASE_URL}/log-options`);
                if (!res.ok) return;
                const data = await res.json();
                const trials = Array.from(new Set([...(data.trials||[]), ...(data.experiments||[])]))
                                  .filter(Boolean).sort((a,b)=>a<b?-1:a>b?1:0);
                const sel = document.getElementById('k-trial');
                sel.innerHTML = '';
                const optAll = document.createElement('option'); optAll.value = ''; optAll.textContent = 'All'; sel.appendChild(optAll);
                for (const t of trials){ const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o);}                
                // Restore persisted selection
                const saved = localStorage.getItem('eulerdash.trial') || '';
                if (saved && trials.includes(saved)) sel.value = saved;
            } catch {}
        }

        async function refreshActivity(){
            try{
                const trialSel = document.getElementById('k-trial');
                const params = new URLSearchParams({ n: '50', order: 'latest' });
                if (trialSel && trialSel.value) params.set('trial', trialSel.value);
                const res = await fetch(`${API_BASE_URL}/logs?${params.toString()}`);
                if(!res.ok) return;
                const d = await res.json();
                const logs = d.logs || [];
                document.getElementById('k-logs').textContent = logs.length;
                const uniq = new Set(logs.map(x => x.student_id).filter(Boolean));
                document.getElementById('k-students').textContent = uniq.size;
                drawSpark(logs);
                document.getElementById('k-upd').textContent = `Updated ${new Date().toLocaleTimeString()}`;
            } catch {}
        }

        document.getElementById('k-trial').addEventListener('change', (e)=>{
            localStorage.setItem('eulerdash.trial', e.target.value || '');
            refreshActivity();
        });

        document.addEventListener('DOMContentLoaded', ()=>{ refreshActive(); refreshAuth(); loadTrialOptions().then(refreshActivity); setInterval(()=>{ refreshActive(); refreshActivity(); }, 5000); });
  </script>
  <script src="scripts/theme.js"></script>
</body>
</html>
