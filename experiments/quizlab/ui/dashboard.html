<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>QuizLab • Home</title>
  <link rel="stylesheet" href="style/app.css" />
  </head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="link" href="/">← Experiments</a>
      <div class="spacer"></div>
      <span id="active" class="badge">Active: …</span>
    </div>
    <h1 style="margin:8px 0 10px 0;">QuizLab</h1>
    <p class="msg">A crisp, minimal lab space. Manage your roster and explore live logs.</p>

    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));margin-top:10px">
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Activity (last 50)</h3>
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
          <div style="display:flex; align-items:center; gap:6px;">
            <label for="k-trial" class="msg">Trial</label>
            <select id="k-trial" class="input" style="padding:6px 8px; min-width:160px;">
              <option value="">All</option>
            </select>
          </div>
          <div class="kpi"><span class="num" id="k-logs">0</span><span class="pill">logs</span></div>
          <div class="kpi"><span class="num" id="k-students">0</span><span class="pill">students</span></div>
        </div>
        <div style="margin-top:8px"><canvas id="k-spark" width="340" height="48" class="spark-canvas"></canvas></div>
        <div class="msg" id="k-upd">—</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Roster</h3>
        <p class="msg">Add/remove students. Bulk‑import via CSV.</p>
        <div style="margin-top:10px"><a class="btn" href="roster.html">Open Roster</a></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Log Stream</h3>
        <p class="msg">Filter by student or tag. Watch class activity in near‑real time.</p>
        <div style="margin-top:10px"><a class="btn" href="stream.html">Open Logs</a></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Quiz</h3>
        <p class="msg">Multiple‑choice questions. Each answer is logged instantly.</p>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px">
          <a class="btn" href="quiz.html">Open Quiz</a>
          <a class="link" href="QUIZ_AUTHORING.md" target="_blank" rel="noopener">Authoring Guide</a>
        </div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Quiz Stats</h3>
        <p class="msg">Open a dedicated page to explore answer distributions and accuracy.</p>
        <div style="margin-top:10px"><a id="open-stats" class="btn" href="quiz-stats.html">Open Stats</a></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Auth</h3>
        <p class="msg">Admin endpoints require login.</p>
        <div style="display:flex;gap:8px;margin-top:10px">
          <a class="btn ghost" href="login.html">Login</a>
          <button id="logout" class="btn ghost">Logout</button>
          <span id="auth" class="pill">…</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const origin = window.location.origin;
    const m = window.location.pathname.match(/\/exp\/([^\/]+)/);
    const exp = m ? m[1] : null;
    async function refreshActive(){ try{ const r=await fetch(`${origin}/api/active-experiment`); const d=await r.json(); document.getElementById('active').textContent = `Active: ${d.active || 'none'}`; }catch{} }
    function drawSpark(logs){
      const cvs = document.getElementById('k-spark'); if(!cvs) return; const ctx = cvs.getContext('2d');
      const W = cvs.width, H = cvs.height; ctx.clearRect(0,0,W,H);
      const cs = getComputedStyle(document.documentElement);
      const baseColor = cs.getPropertyValue('--border')?.trim() || '#233';
      const strokeColor = getComputedStyle(document.body).color || '#77ffd7';
      const now = Date.now(); const win = 10*60*1000; const start = now - win; const buckets = 20; const step = win / buckets;
      const counts = new Array(buckets).fill(0);
      for(const row of logs){
        const t = Date.parse(row.ts || '') || 0; if(t < start) continue; const idx = Math.min(buckets-1, Math.max(0, Math.floor((t - start)/step))); counts[idx]++;
      }
      const maxV = Math.max(1, ...counts);
      ctx.strokeStyle = baseColor; ctx.beginPath(); ctx.moveTo(0, H-1); ctx.lineTo(W, H-1); ctx.stroke();
      ctx.strokeStyle = strokeColor; ctx.lineWidth = 2; ctx.beginPath();
      for(let i=0;i<buckets;i++){
        const x = (i/(buckets-1))*W; const y = H - 2 - (counts[i]/maxV)*(H-6);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }

    async function loadTrialOptions(){
      try{
        const r = await fetch(`${origin}/log-options`);
        if(!r.ok) return;
        const data = await r.json();
        const trials = Array.from(new Set([...(data.trials||[]), ...(data.experiments||[])])).filter(Boolean).sort((a,b)=>a<b?-1:a>b?1:0);
        const sel = document.getElementById('k-trial');
        sel.innerHTML = '';
        const optAll = document.createElement('option'); optAll.value=''; optAll.textContent='All'; sel.appendChild(optAll);
        for(const t of trials){ const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o); }
        const saved = localStorage.getItem('quizlabdash.trial') || '';
        if (saved && trials.includes(saved)) sel.value = saved;
      }catch{}
    }

    async function refreshActivity(){
      try{ 
        const sel = document.getElementById('k-trial');
        const params = new URLSearchParams({ n: '50', order: 'latest' });
        if (sel && sel.value) params.set('trial', sel.value);
        const r=await fetch(`${origin}/logs?${params.toString()}`); if(!r.ok) return; const d=await r.json(); const logs=d.logs||[]; document.getElementById('k-logs').textContent=logs.length; const uniq=new Set(logs.map(x=>x.student_id).filter(Boolean)); document.getElementById('k-students').textContent=uniq.size; drawSpark(logs); document.getElementById('k-upd').textContent = `Updated ${new Date().toLocaleTimeString()}`; }catch{}
    }

    document.getElementById('open-stats').addEventListener('click', (e)=>{
      e.preventDefault();
      const sel = document.getElementById('k-trial');
      const url = new URL('quiz-stats.html', location.href);
      if (sel && sel.value) url.searchParams.set('trial', sel.value);
      window.location.href = url.toString();
    });
    async function ping(){
      try{ const r=await fetch(`${origin}${exp?`/exp/${exp}`:''}/admin/ping`,{credentials:'include'}); document.getElementById('auth').textContent = r.ok? 'logged in': 'logged out'; }catch{ document.getElementById('auth').textContent='unknown'; }
    }
    document.getElementById('logout').onclick = async()=>{ try{ await fetch(`${origin}${exp?`/exp/${exp}`:''}/admin/logout`,{method:'POST',credentials:'include'});}catch{}; ping(); };
    document.getElementById('k-trial').addEventListener('change', (e)=>{
      localStorage.setItem('quizlabdash.trial', e.target.value || '');
      refreshActivity();
    });
    (async()=>{ refreshActive(); await loadTrialOptions(); await refreshActivity(); setInterval(()=>{ refreshActive(); refreshActivity(); }, 5000); })();
    ping();
  </script>
</body>
</html>
