<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>QuizLab • Quiz</title>
  <link rel="stylesheet" href="style/app.css" />
  <!-- Markdown + Math + Code highlight (CDN for minimal change) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <style>
    .q{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
    .q h3{margin:0 0 8px 0}
    .choices{display:grid;gap:8px}
    .row{display:flex;gap:8px;align-items:center}
    .row .spacer{flex:1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="link" href="dashboard.html">← Back</a>
      <div class="spacer"></div>
      <span id="active" class="badge">Active: …</span>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div class="field"><label>Student ID</label><input id="sid" class="input" placeholder="e.g. s001"></div>
        <div class="field"><label>Trial (optional)</label><input id="trial" class="input" placeholder="e.g. quiz-01"></div>
        <div class="field">
          <label>Quiz File</label>
          <select id="quizFile" class="input"></select>
        </div>
        <div class="field"><label>&nbsp;</label><span id="reg" class="pill">—</span></div>
      </div>
      <div class="msg">Answers are logged immediately when you submit. Choose a quiz file from the dropdown.</div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div class="row">
        <button id="statsBtn" class="btn">Open Statistics</button>
        <span class="msg">Opens stats page for the selected quiz</span>
        <div class="spacer"></div>
        <a class="link" href="QUIZ_AUTHORING.md" target="_blank" rel="noopener">Authoring Guide</a>
      </div>
    </div>

    <div id="qs" class="stack"></div>
  </div>

  <script>
    // Markdown renderer with KaTeX + code highlighting
  </script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.2/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it-katex@2.0.3/dist/markdown-it-katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/build/highlight.min.js"></script>
  <script>
    let _md = null;
    if (window.markdownit) {
      _md = window.markdownit({
        html: false,
        linkify: true,
        typographer: true,
        highlight: (str, lang) => {
          try {
            if (lang && window.hljs && window.hljs.getLanguage(lang)) {
              return `<pre><code class=\"hljs language-${lang}\">` +
                     window.hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                     '</code></pre>';
            }
          } catch {}
          const esc = _md.utils.escapeHtml(str);
          return `<pre><code class=\"hljs\">${esc}</code></pre>`;
      }
      });
      if (window.markdownitKatex) {
        try { _md = _md.use(window.markdownitKatex); } catch {}
      }
    }
    function renderMD(s){
      const txt = String(s || '');
      if (_md) {
        try { return DOMPurify.sanitize(_md.render(txt)); } catch {}
      }
      let html = txt
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      html = html.replace(/```([\s\S]*?)```/g, (m, code) => `<pre><code class=\"hljs\">${code.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</code></pre>`);
      html = html.replace(/`([^`]+)`/g, (m, code) => `<code>${code.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</code>`);
      return DOMPurify.sanitize(html);
    }
    const origin = location.origin; const m = location.pathname.match(/\/exp\/([^\/]+)/); const exp = m? m[1]: null;
    (async()=>{ try{ const r=await fetch(`${origin}/api/active-experiment`); const d=await r.json(); document.getElementById('active').textContent = `Active: ${d.active || 'none'}`; }catch{} })();
    const qsEl = document.getElementById('qs');
    const sidEl = document.getElementById('sid');
    const trialEl = document.getElementById('trial');
    const regEl = document.getElementById('reg');
    const api = (p)=> `${origin}${p}`;
    const statsBtn = document.getElementById('statsBtn');
    const quizFileSel = document.getElementById('quizFile');

    // Persist student id
    sidEl.value = localStorage.getItem('quizlab.quiz.sid') || '';
    sidEl.addEventListener('input', ()=> localStorage.setItem('quizlab.quiz.sid', sidEl.value.trim()));
    trialEl.value = localStorage.getItem('quizlab.quiz.trial') || '';
    trialEl.addEventListener('input', ()=> localStorage.setItem('quizlab.quiz.trial', trialEl.value.trim()));

    async function checkRegistration(){
      const sid = (sidEl.value||'').trim();
      if(!sid){ regEl.textContent = '—'; regEl.className='pill'; return; }
      try{
        const r = await fetch(`${origin}/is-registered?student_id=${encodeURIComponent(sid)}`);
        if(!r.ok) throw new Error();
        const d = await r.json();
        const ok = !!d.registered; regEl.textContent = ok? 'Registered':'Not registered'; regEl.className = `pill ${ok? 'ok':'err'}`;
      }catch{ regEl.textContent='?'; regEl.className='pill'; }
    }
    let _regTimer=null;
    function debounceRegCheck() {
      if (_regTimer) clearTimeout(_regTimer);
      _regTimer = setTimeout(checkRegistration, 300);
    }
    sidEl.addEventListener('input', debounceRegCheck);

    let QUESTIONS = [];
    let QUIZ_FILE = 'questions.md';

    async function loadQuizManifest(){
      const listUrl = exp ? `${origin}/exp/${exp}/files?ext=md&dir=quiz` : 'files?ext=md&dir=quiz';
      let files = [];
      try {
        const r = await fetch(listUrl, { cache: 'no-store' });
        if (r.ok) {
          const data = await r.json();
          const arr = (data && Array.isArray(data.files)) ? data.files : [];
          files = arr.filter(x => typeof x === 'string' && x.toLowerCase().endsWith('.md'));
        }
      } catch {}
      if (files.length === 0) {
        const candidates = ['quiz/questions.md', 'quiz/derivatives.md', 'quiz/quiz.md'];
        const found = [];
        for (const name of candidates) {
          try { const head = await fetch(name, { method:'HEAD', cache:'no-store' }); if (head.ok) found.push(name); } catch {}
        }
        files = found.length ? found.map(n => n.replace(/^quiz\//,'')) : ['questions.md'];
      }
      quizFileSel.innerHTML = '';
      for (const f of files) {
        const opt = document.createElement('option');
        opt.value = f; opt.textContent = f.replace(/\.md$/,'');
        quizFileSel.appendChild(opt);
      }
      const saved = localStorage.getItem('quizlab.quiz.file');
      if (saved && files.includes(saved)) quizFileSel.value = saved;
      QUIZ_FILE = quizFileSel.value || files[0] || 'questions.md';
    }

    async function loadQuestions() {
      try {
        const response = await fetch(`quiz/${QUIZ_FILE}`, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const markdown = await response.text();
        QUESTIONS = parseQuestionsEnhanced(markdown);
      } catch (error) {
        console.error('Failed to load questions:', error);
        QUESTIONS = [
          { id: 'q1', text: 'Which method finds roots by halving intervals?', choices: [ 'Newton-Raphson', 'Secant', 'Bisection', 'Fixed-point' ], correct: 2 },
          { id: 'q2', text: 'Derivative of x^2 is:', choices: [ 'x', '2x', 'x^3', 'constant' ], correct: 1 },
          { id: 'q3', text: 'Matrix multiplication A(m×n)·B(n×p) yields shape:', choices: [ 'm×n', 'n×p', 'm×p', 'p×m' ], correct: 2 },
        ];
      }
    }

    function parseQuestionsEnhanced(markdown) {
      const questions = [];
      const sections = markdown.split(/^## Question \d+: (\w+)/m);
      for (let i = 1; i < sections.length; i += 2) {
        const id = sections[i];
        const content = sections[i + 1] || '';
        const lines = content.trim().split('\n');
        let text = '';
        let inFence = false;
        for (const line of lines) {
          const t = line.trim();
          if (t.startsWith('```')) { inFence = !inFence; continue; }
          if (inFence) continue;
          const m = line.match(/\*\*(.*?)\*\*/);
          if (m) { text = (m[1] || '').trim(); break; }
        }
        if (!text) continue;
        const choices = [];
        const correctIdxs = [];
        let foundParen = false, foundBracket = false;
        inFence = false;
        for (const raw of lines) {
          const t = raw.trim();
          if (t.startsWith('```')) { inFence = !inFence; continue; }
          if (inFence) continue;
          let m = raw.match(/^[A-Z]\)\s*(.*?)\s*(✓)?\s*$/);
          let isMulti = false;
          if (!m) { m = raw.match(/^[A-Z]\]\s*(.*?)\s*(✓)?\s*$/); isMulti = !!m; }
          if (m) {
            const choiceText = (m[1] || '').trim();
            const hasTick = !!m[2];
            if (isMulti) foundBracket = true; else foundParen = true;
            const idx = choices.length;
            choices.push(choiceText);
            if (hasTick) correctIdxs.push(idx);
          }
        }
        const isMultiQ = foundBracket && !foundParen ? true : (foundParen && !foundBracket ? false : (correctIdxs.length>1));
        const q = { id, text, choices };
        if (isMultiQ) { q.multi = true; q.correct = correctIdxs; } else { q.multi = false; q.correct = correctIdxs.length? correctIdxs[0]: -1; }
        questions.push(q);
      }
      return questions;
    }

    function render(){
      const wrapAll = document.createElement('div');
      qsEl.innerHTML = '';
      QUESTIONS.forEach((q,i)=>{
        const wrap = document.createElement('div'); wrap.className='q';
        wrap.innerHTML = `<h3>Q${i+1}. ${renderMD(q.text)}</h3>`;
        const choices = document.createElement('div'); choices.className='choices';
        const name = `q_${i}`;
        q.choices.forEach((t,j)=>{
          const row = document.createElement('label'); row.className='row';
          const input = document.createElement('input'); input.type = q.multi? 'checkbox': 'radio'; input.name = name; input.value = String(j);
          const span = document.createElement('span'); span.innerHTML = renderMD(t);
          row.appendChild(input); row.appendChild(span);
          choices.appendChild(row);
        });
        const bar = document.createElement('div'); bar.className='row'; bar.style.marginTop='8px';
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Submit';
        const msg = document.createElement('span'); msg.className='msg';
        bar.appendChild(btn); bar.appendChild(msg); bar.appendChild(document.createElement('div')).className='spacer';
        wrap.appendChild(choices); wrap.appendChild(bar);

        btn.onclick = async () => {
          const sid = (sidEl.value||'').trim(); if(!sid){ alert('Enter Student ID'); return; }
          const selected = Array.from(choices.querySelectorAll('input:checked')).map(el=>Number(el.value));
          if(!selected.length){ alert('Pick an answer'); return; }
          const trial = (trialEl.value||'').trim();
          const payloadSingle = { kind:'quiz', type:'single', quizname: (QUIZ_FILE||'').replace(/\.md$/,''), qid:q.id, question:q.text, choice_index:selected[0], choice_text: String(q.choices[selected[0]]||''), ts: new Date().toISOString() };
          const payloadMulti = { kind:'quiz', type:'multi', quizname: (QUIZ_FILE||'').replace(/\.md$/,''), qid:q.id, question:q.text, choice_indices:selected, choice_texts: selected.map(k=> String(q.choices[k]||'')), ts: new Date().toISOString() };
          const args = [ q.multi? payloadMulti: payloadSingle ];
          try{
            const r = await fetch(`${origin}/call`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ student_id: sid, func_name:'echo', args, experiment_name: exp, trial }) });
            if(!r.ok){ msg.textContent = `Error: HTTP ${r.status}`; msg.className='msg err'; return; }
            msg.textContent='Logged'; msg.className='msg ok';
          }catch(e){ msg.textContent='Network error'; msg.className='msg err'; }
        };

        qsEl.appendChild(wrap);
      });
    }

    (async () => {
      qsEl.innerHTML = '<div style="text-align:center;padding:20px;">Loading questions...</div>';
      try {
        await loadQuizManifest();
        await loadQuestions();
        render();
        if ((sidEl.value || '').trim()) { checkRegistration(); }
      } catch (error) {
        qsEl.innerHTML = '<div style="text-align:center;padding:20px;color:red;">Failed to load questions. Using fallback questions.</div>';
        setTimeout(() => render(), 1000);
      }
    })();

    quizFileSel.addEventListener('change', async ()=>{
      QUIZ_FILE = quizFileSel.value || 'questions.md';
      localStorage.setItem('quizlab.quiz.file', QUIZ_FILE);
      qsEl.innerHTML = '<div style="text-align:center;padding:20px;">Loading questions...</div>';
      await loadQuestions();
      render();
    });

    statsBtn.addEventListener('click', ()=>{
      const quizname = (QUIZ_FILE || '').replace(/\.md$/,'');
      const trial = (trialEl.value||'').trim();
      const url = new URL('quiz-stats.html', location.href);
      url.searchParams.set('quiz', quizname);
      if (trial) url.searchParams.set('trial', trial);
      window.open(url.toString(), '_blank');
    });
  </script>
</body>
</html>
