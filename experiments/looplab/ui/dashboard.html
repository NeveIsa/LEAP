<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>LoopLab • Home</title>
  <link rel="stylesheet" href="style/app.css" />
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="link" href="/">← Experiments</a>
      <div class="spacer"></div>
      <span id="active" class="badge">Active: …</span>
    </div>
    <h1 style="margin:8px 0 10px 0;">LoopLab</h1>
    <p class="msg">A crisp, minimal lab space. Manage your roster and explore live logs.</p>

    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));margin-top:10px">
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Activity (last 50)</h3>
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
          <div style="display:flex; align-items:center; gap:6px;">
            <label for="k-trial" class="msg">Trial</label>
            <select id="k-trial" class="input" style="padding:6px 8px; min-width:160px;">
              <option value="">All</option>
            </select>
          </div>
          <div class="kpi"><span class="num" id="k-logs">0</span><span class="pill">logs</span></div>
          <div class="kpi"><span class="num" id="k-students">0</span><span class="pill">students</span></div>
        </div>
        <div style="margin-top:8px"><canvas id="k-spark" width="340" height="48" class="spark-canvas"></canvas></div>
        <div class="msg" id="k-upd">—</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Roster</h3>
        <p class="msg">Add/remove students. Bulk‑import via CSV.</p>
        <div style="margin-top:10px"><a class="btn" href="roster.html">Open Roster</a></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Log Stream</h3>
        <p class="msg">Filter by student or tag. Watch class activity in near‑real time.</p>
        <div style="margin-top:10px"><a class="btn" href="stream.html">Open Logs</a></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Quiz</h3>
        <p class="msg">Multiple‑choice questions. Each answer is logged instantly.</p>
        <div style="margin-top:10px"><a class="btn" href="quiz.html">Open Quiz</a></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Quiz Stats</h3>
        <p class="msg">See distribution of answers and accuracy. Uses recent logs.</p>
        <div class="row" style="gap:8px; flex-wrap:wrap; margin:8px 0;">
          <button id="qstats-refresh" class="btn">Refresh Stats</button>
          <button id="qstats-csv" class="btn ghost">Export CSV</button>
          <label class="row" style="gap:6px; font-size: 0.9em; opacity: 0.9">
            <input id="qstats-dedupe" type="checkbox" checked>
            <span>Deduplicate by student</span>
          </label>
          <span id="qstats-status" class="msg">—</span>
        </div>
        <div id="qstats-panel" class="msg">No data yet.</div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Auth</h3>
        <p class="msg">Admin endpoints require login.</p>
        <div style="display:flex;gap:8px;margin-top:10px">
          <a class="btn ghost" href="login.html">Login</a>
          <button id="logout" class="btn ghost">Logout</button>
          <span id="auth" class="pill">…</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const origin = window.location.origin;
    const m = window.location.pathname.match(/\/exp\/([^\/]+)/);
    const exp = m ? m[1] : null;
    async function refreshActive(){ try{ const r=await fetch(`${origin}/api/active-experiment`); const d=await r.json(); document.getElementById('active').textContent = `Active: ${d.active || 'none'}`; }catch{} }
    function drawSpark(logs){
      const cvs = document.getElementById('k-spark'); if(!cvs) return; const ctx = cvs.getContext('2d');
      const W = cvs.width, H = cvs.height; ctx.clearRect(0,0,W,H);
      const cs = getComputedStyle(document.documentElement);
      const baseColor = cs.getPropertyValue('--border')?.trim() || '#233';
      const strokeColor = getComputedStyle(document.body).color || '#77ffd7';
      // Window: last 10 minutes, 20 buckets (30s each)
      const now = Date.now(); const win = 10*60*1000; const start = now - win; const buckets = 20; const step = win / buckets;
      const counts = new Array(buckets).fill(0);
      for(const row of logs){
        const t = Date.parse(row.ts || '') || 0; if(t < start) continue; const idx = Math.min(buckets-1, Math.max(0, Math.floor((t - start)/step))); counts[idx]++;
      }
      const maxV = Math.max(1, ...counts);
      // Draw baseline
      ctx.strokeStyle = baseColor; ctx.beginPath(); ctx.moveTo(0, H-1); ctx.lineTo(W, H-1); ctx.stroke();
      // Draw line
      ctx.strokeStyle = strokeColor; ctx.lineWidth = 2; ctx.beginPath();
      for(let i=0;i<buckets;i++){
        const x = (i/(buckets-1))*W; const y = H - 2 - (counts[i]/maxV)*(H-6);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }

    async function loadTrialOptions(){
      try{
        const r = await fetch(`${origin}/log-options`);
        if(!r.ok) return;
        const data = await r.json();
        const trials = Array.from(new Set([...(data.trials||[]), ...(data.experiments||[])])).filter(Boolean).sort((a,b)=>a<b?-1:a>b?1:0);
        const sel = document.getElementById('k-trial');
        sel.innerHTML = '';
        const optAll = document.createElement('option'); optAll.value=''; optAll.textContent='All'; sel.appendChild(optAll);
        for(const t of trials){ const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o); }
        // Restore persisted selection
        const saved = localStorage.getItem('looplabdash.trial') || '';
        if (saved && trials.includes(saved)) sel.value = saved;
      }catch{}
    }

    async function refreshActivity(){
      try{ 
        const sel = document.getElementById('k-trial');
        const params = new URLSearchParams({ n: '50', order: 'latest' });
        if (sel && sel.value) params.set('trial', sel.value);
        const r=await fetch(`${origin}/logs?${params.toString()}`); if(!r.ok) return; const d=await r.json(); const logs=d.logs||[]; document.getElementById('k-logs').textContent=logs.length; const uniq=new Set(logs.map(x=>x.student_id).filter(Boolean)); document.getElementById('k-students').textContent=uniq.size; drawSpark(logs); document.getElementById('k-upd').textContent = `Updated ${new Date().toLocaleTimeString()}`; }catch{}
    }

    // -----------------
    // Quiz Stats helpers
    // -----------------
    function parseQuizEventsFromLogs(logs){
      const events = [];
      for(const row of logs){
        try{
          const args = row.args_json; // server parses JSON
          if(Array.isArray(args) && args.length>0 && args[0] && args[0].kind==='quiz'){
            const p = args[0];
            events.push({
              ts: row.ts,
              student_id: row.student_id,
              qid: p.qid,
              question: p.question,
              choice_index: Number(p.choice_index),
              choice_text: p.choice_text
            });
          }
        }catch{}
      }
      return events;
    }

    function dedupeQuizEvents(events){
      const latest = new Map();
      for(const e of events){
        const key = `${e.qid}::${e.student_id}`;
        const prev = latest.get(key);
        if(!prev || e.ts > prev.ts) latest.set(key, e);
      }
      return Array.from(latest.values());
    }

    function computeQuizStats(events){
      // Build question index from questions.md not loaded here; compute per qid from events only
      const byQ = new Map();
      for(const e of events){
        let rec = byQ.get(e.qid);
        if(!rec){ rec = { qid: e.qid, question: e.question || e.qid, counts: new Map(), total: 0 }; byQ.set(e.qid, rec); }
        rec.total += 1;
        rec.counts.set(e.choice_index, (rec.counts.get(e.choice_index)||0)+1);
      }
      // Convert to sorted array by qid
      return Array.from(byQ.values()).sort((a,b)=> String(a.qid).localeCompare(String(b.qid)));
    }

    function renderQuizStats(stats){
      if(!stats.length){
        document.getElementById('qstats-panel').innerHTML = '<span class="msg">No quiz answers found in recent logs.</span>';
        return;
      }
      let html = '';
      html += '<div style="overflow:auto">';
      html += '<table style="width:100%; border-collapse:collapse">';
      html += '<thead><tr>'+
        '<th style="padding:6px 8px; border-bottom:1px solid var(--border); text-align:left">Question</th>'+
        '<th style="padding:6px 8px; border-bottom:1px solid var(--border); text-align:center">Total</th>'+
        '<th style="padding:6px 8px; border-bottom:1px solid var(--border); text-align:left">Counts by option</th>'+
        '</tr></thead><tbody>';
      for(const row of stats){
        const parts = [];
        const keys = Array.from(row.counts.keys()).sort((a,b)=>a-b);
        for(const k of keys){
          const letter = String.fromCharCode(65 + (Number(k)||0));
          parts.push(`${letter}: ${row.counts.get(k)}`);
        }
        const qtext = (row.question||'').length>90? (row.question||'').slice(0,87)+'…': (row.question||'');
        html += '<tr>'+
          `<td style="padding:6px 8px; border-bottom:1px solid var(--border);">${qtext}</td>`+
          `<td style="padding:6px 8px; border-bottom:1px solid var(--border); text-align:center">${row.total}</td>`+
          `<td style="padding:6px 8px; border-bottom:1px solid var(--border); font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;">${parts.join('  ·  ')}</td>`+
          '</tr>';
      }
      html += '</tbody></table></div>';
      document.getElementById('qstats-panel').innerHTML = html;
    }

    async function refreshQuizStats(){
      const status = document.getElementById('qstats-status');
      status.textContent = 'Loading…'; status.className = 'msg';
      try{
        const sel = document.getElementById('k-trial');
        const params = new URLSearchParams({ n: '1000', order: 'latest' });
        if (sel && sel.value) params.set('trial', sel.value);
        const r = await fetch(`${origin}/logs?${params.toString()}`);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const d = await r.json();
        let events = parseQuizEventsFromLogs(d.logs||[]);
        if(document.getElementById('qstats-dedupe').checked) events = dedupeQuizEvents(events);
        const stats = computeQuizStats(events);
        renderQuizStats(stats);
        status.textContent = `Updated ${new Date().toLocaleTimeString()}`; status.className = 'msg ok';
      }catch(e){ status.textContent = e.message || String(e); status.className = 'msg err'; }
    }

    function exportQuizCSV(){
      const panel = document.getElementById('qstats-panel');
      // Re-fetch logs for a consistent export
      (async()=>{
        const sel = document.getElementById('k-trial');
        const params = new URLSearchParams({ n: '5000', order: 'latest' });
        if (sel && sel.value) params.set('trial', sel.value);
        const r = await fetch(`${origin}/logs?${params.toString()}`);
        if(!r.ok) return;
        const d = await r.json();
        let events = parseQuizEventsFromLogs(d.logs||[]);
        if(document.getElementById('qstats-dedupe').checked) events = dedupeQuizEvents(events);
        const lines = [ ['student_id','qid','question','choice_index','choice_text','ts'].map(v=>`"${String(v).replaceAll('"','""')}"`).join(',') ];
        for(const e of events){
          const row = [e.student_id, e.qid, e.question||'', e.choice_index, e.choice_text||'', e.ts]
            .map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(',');
          lines.push(row);
        }
        const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const trial = sel && sel.value ? sel.value : 'all';
        a.href = url; a.download = `looplab_quiz_${trial}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setTimeout(()=> URL.revokeObjectURL(url), 1000);
      })();
    }

    document.getElementById('qstats-refresh').addEventListener('click', refreshQuizStats);
    document.getElementById('qstats-csv').addEventListener('click', exportQuizCSV);
    async function ping(){
      try{ const r=await fetch(`${origin}${exp?`/exp/${exp}`:''}/admin/ping`,{credentials:'include'}); document.getElementById('auth').textContent = r.ok? 'logged in': 'logged out'; }catch{ document.getElementById('auth').textContent='unknown'; }
    }
    document.getElementById('logout').onclick = async()=>{ try{ await fetch(`${origin}${exp?`/exp/${exp}`:''}/admin/logout`,{method:'POST',credentials:'include'});}catch{}; ping(); };
    document.getElementById('k-trial').addEventListener('change', (e)=>{
      localStorage.setItem('looplabdash.trial', e.target.value || '');
      refreshActivity();
    });
    (async()=>{ refreshActive(); await loadTrialOptions(); await refreshActivity(); setInterval(()=>{ refreshActive(); refreshActivity(); }, 5000); })();
    ping();
  </script>
</body>
</html>
