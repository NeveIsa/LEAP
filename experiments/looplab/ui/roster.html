<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>LoopLab • Roster</title>
  <link rel="stylesheet" href="style/app.css" />
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="link" href="dashboard.html">← Back</a>
      <div class="spacer"></div>
      <span id="scope" class="badge">Scope</span>
      <a class="link" href="login.html">Login</a>
    </div>

    <div class="grid" style="margin-bottom:16px">
      <div class="card">
        <h3 style="margin-top:0">Add Student</h3>
        <div class="field"><label>Student ID</label><input class="input" id="sid"></div>
        <div class="field"><label>Name</label><input class="input" id="name"></div>
        <div class="field"><label>Email (optional)</label><input class="input" id="email"></div>
        <button class="btn" id="add">Add</button>
        <span id="msg" class="msg"></span>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Bulk CSV</h3>
        <p class="msg">Headers: sid,name,email</p>
        <input type="file" id="csv" accept=".csv,text/csv"/>
        <div class="kpi" style="margin-top:10px"><span class="num" id="count">0</span><span class="pill">parsed</span></div>
        <div style="margin-top:10px;display:flex;gap:8px"><button class="btn ghost" id="preview">Preview</button><button class="btn" id="upload" disabled>Register</button></div>
        <div id="csvMsg" class="msg"></div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;gap:10px;">
        <h3 style="margin:0">Students</h3>
        <span id="total" class="pill">0</span>
        <div class="spacer"></div>
        <span class="msg">Tip: Click a row to manage.</span>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table class="table" id="tbl"><thead><tr><th>Student ID</th><th>Name</th><th>Email</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <script>
    const origin=location.origin; const m=location.pathname.match(/\/exp\/([^\/]+)/); const exp=m?m[1]:null; document.getElementById('scope').textContent=`Scope: ${exp||'root'}`;
    const api = (p)=> `${origin}${exp?`/exp/${exp}`:''}${p}`;
    const tblBody = document.querySelector('#tbl tbody');
    const total = document.getElementById('total');
    const msg = document.getElementById('msg');

    function setMsg(el, text, ok=false){ el.textContent = text; el.className = `msg ${ok?'ok':'err'}`; }
    async function extractError(resp){ try{ const d=await resp.json(); if(d && d.detail!==undefined){ return typeof d.detail==='string'? d.detail: JSON.stringify(d.detail);} }catch{} try{ return await resp.text(); }catch{} return ''; }

    async function load(){
      try{ const r=await fetch(api('/admin/students'),{credentials:'include'}); if(!r.ok){ if(r.status===401){ setMsg(msg,'Login required'); return; } if(r.status===409){ setMsg(msg,'No active experiment'); return; } throw new Error(await extractError(r)||`HTTP ${r.status}`);} const d=await r.json(); const rows=d.students||[]; tblBody.innerHTML=''; rows.forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.student_id}</td><td>${s.name}</td><td>${s.email||''}</td>`; tr.onclick=()=> manage(s); tblBody.appendChild(tr); }); total.textContent=rows.length; msg.textContent=''; msg.className='msg'; }
      catch(e){ setMsg(msg, e.message||String(e)); }
    }

    async function manage(s){
      const act = prompt(`Manage ${s.student_id} (d=delete, c=clear logs, other=cancel)`);
      if(act==='d'){ if(!confirm(`Delete ${s.student_id}?`)) return; const r=await fetch(api(`/admin/student/${s.student_id}`),{method:'DELETE',credentials:'include'}); if(!r.ok){ alert(await extractError(r)||`HTTP ${r.status}`); return;} await load(); }
      if(act==='c'){ if(!confirm(`Delete ALL logs for ${s.student_id}?`)) return; const r=await fetch(api(`/admin/logs/student/${s.student_id}`),{method:'DELETE',credentials:'include'}); if(!r.ok){ alert(await extractError(r)||`HTTP ${r.status}`); return;} alert('Logs cleared'); }
    }

    document.getElementById('add').onclick = async () => {
      const sid=document.getElementById('sid').value.trim();
      const name=document.getElementById('name').value.trim();
      const email=document.getElementById('email').value.trim();
      if(!sid||!name){ setMsg(msg,'Student ID and Name required'); return; }
      try{ const r=await fetch(api('/admin/add-student'),{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({student_id:sid,name,email:email||undefined})}); if(!r.ok){ throw new Error(await extractError(r)||`HTTP ${r.status}`);} setMsg(msg,'Added',true); document.getElementById('sid').value=''; document.getElementById('name').value=''; document.getElementById('email').value=''; await load(); } catch(e){ setMsg(msg,e.message||String(e)); }
    };

    let parsed=null; const csvEl=document.getElementById('csv'); const count=document.getElementById('count'); const csvMsg=document.getElementById('csvMsg');
    document.getElementById('preview').onclick = async ()=>{
      if(!csvEl.files?.length){ csvMsg.textContent='Choose a CSV'; return; }
      const text = await csvEl.files[0].text();
      const rows = text.split(/\r?\n/).map(l=>l.split(',')); if(!rows.length){ csvMsg.textContent='Empty file'; return; }
      const head=rows[0].map(h=>h.trim()); const is = {sid:head.indexOf('sid'), name:head.indexOf('name'), email:head.indexOf('email')}; if(is.sid<0||is.name<0){ csvMsg.textContent='Headers required: sid,name[,email]'; return; }
      const clean=[]; for(let i=1;i<rows.length;i++){ const r=rows[i]; if(!r||r.every(c=>!String(c||'').trim())) continue; const sid=String(r[is.sid]||'').trim(); const nm=String(r[is.name]||'').trim(); const em=is.email>=0? String(r[is.email]||'').trim():''; if(!sid||!nm) continue; clean.push({student_id:sid,name:nm,email:em||undefined}); }
      parsed=clean; count.textContent=clean.length; document.getElementById('upload').disabled = clean.length===0; csvMsg.textContent = clean.length? 'Ready to register':'No valid rows';
    };
    document.getElementById('upload').onclick = async ()=>{
      if(!parsed?.length) return; let ok=0, fail=0; for(const s of parsed){ try{ const r=await fetch(api('/admin/add-student'),{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(s)}); if(!r.ok) throw new Error(); ok++; }catch{ fail++; } }
      csvMsg.textContent = `Done. Success ${ok}, Failed ${fail}`; parsed=null; document.getElementById('upload').disabled=true; csvEl.value=''; await load();
    };

    load();
  </script>
</body>
</html>

