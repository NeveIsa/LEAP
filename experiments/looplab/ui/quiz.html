<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>LoopLab • Quiz</title>
  <link rel="stylesheet" href="style/app.css" />
  <!-- Markdown + Math + Code highlight (CDN for minimal change) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <style>
    .q{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
    .q h3{margin:0 0 8px 0}
    .choices{display:grid;gap:8px}
    .row{display:flex;gap:8px;align-items:center}
    .row .spacer{flex:1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="link" href="dashboard.html">← Back</a>
      <div class="spacer"></div>
      <span id="active" class="badge">Active: …</span>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div class="field"><label>Student ID</label><input id="sid" class="input" placeholder="e.g. s001"></div>
        <div class="field"><label>Trial (optional)</label><input id="trial" class="input" placeholder="e.g. quiz-01"></div>
        <div class="field">
          <label>Quiz File</label>
          <select id="quizFile" class="input"></select>
        </div>
        <div class="field"><label>&nbsp;</label><span id="reg" class="pill">—</span></div>
      </div>
      <div class="msg">Answers are logged immediately when you submit. Choose a quiz file from the dropdown.</div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div class="row">
        <button id="statsBtn" class="btn">Open Statistics</button>
        <span class="msg">Opens stats page for the selected quiz</span>
        <div class="spacer"></div>
        <a class="link" href="QUIZ_AUTHORING.md" target="_blank" rel="noopener">Authoring Guide</a>
      </div>
    </div>

    <div id="qs" class="stack"></div>
  </div>

  <script>
    // Markdown renderer with KaTeX + code highlighting
  </script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.2/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it-katex@2.0.3/dist/markdown-it-katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/build/highlight.min.js"></script>
  <script>
    let _md = null;
    if (window.markdownit) {
      _md = window.markdownit({
        html: false,
        linkify: true,
        typographer: true,
        highlight: (str, lang) => {
          try {
            if (lang && window.hljs && window.hljs.getLanguage(lang)) {
              return `<pre><code class=\"hljs language-${lang}\">` +
                     window.hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                     '</code></pre>';
            }
          } catch {}
          const esc = _md.utils.escapeHtml(str);
          return `<pre><code class=\"hljs\">${esc}</code></pre>`;
      }
      });
      if (window.markdownitKatex) {
        try { _md = _md.use(window.markdownitKatex); } catch {}
      }
    }
    function renderMD(s){
      const txt = String(s || '');
      if (_md) {
        try { return DOMPurify.sanitize(_md.render(txt)); } catch {}
      }
      // Fallback: minimal code formatting without full markdown
      let html = txt
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      html = html.replace(/```([\s\S]*?)```/g, (m, code) => `<pre><code class=\"hljs\">${code.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</code></pre>`);
      html = html.replace(/`([^`]+)`/g, (m, code) => `<code>${code.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</code>`);
      return DOMPurify.sanitize(html);
    }
    const origin = location.origin; const m = location.pathname.match(/\/exp\/([^\/]+)/); const exp = m? m[1]: null;
    (async()=>{ try{ const r=await fetch(`${origin}/api/active-experiment`); const d=await r.json(); document.getElementById('active').textContent = `Active: ${d.active || 'none'}`; }catch{} })();
    const qsEl = document.getElementById('qs');
    const sidEl = document.getElementById('sid');
    const trialEl = document.getElementById('trial');
    const regEl = document.getElementById('reg');
    const api = (p)=> `${origin}${p}`;
    const statsBtn = document.getElementById('statsBtn');
    const quizFileSel = document.getElementById('quizFile');

    // Persist student id
    sidEl.value = localStorage.getItem('looplab.quiz.sid') || '';
    sidEl.addEventListener('input', ()=> localStorage.setItem('looplab.quiz.sid', sidEl.value.trim()));
    trialEl.value = localStorage.getItem('looplab.quiz.trial') || '';
    trialEl.addEventListener('input', ()=> localStorage.setItem('looplab.quiz.trial', trialEl.value.trim()));

    // Registration status indicator
    regEl.textContent = 'unknown';
    let _regTimer = null;
    async function checkRegistration() {
      const sid = sidEl.value.trim();
      if (!sid) { regEl.textContent = '—'; regEl.className = 'pill'; return; }
      try {
        const r = await fetch(`${origin}/is-registered?student_id=${encodeURIComponent(sid)}`);
        if (!r.ok) throw new Error(String(r.status));
        const d = await r.json();
        if (d && d.registered) { regEl.textContent = 'registered'; regEl.className = 'pill ok'; }
        else { regEl.textContent = 'not registered'; regEl.className = 'pill err'; }
      } catch {
        regEl.textContent = 'unknown'; regEl.className = 'pill';
      }
    }
    function debounceRegCheck() {
      if (_regTimer) clearTimeout(_regTimer);
      _regTimer = setTimeout(checkRegistration, 300);
    }
    sidEl.addEventListener('input', debounceRegCheck);

    let QUESTIONS = [];
    let QUIZ_FILE = 'questions.md';

    async function loadQuizManifest(){
      // Auto-detect quiz markdown files via server endpoint under this experiment
      const listUrl = exp ? `${origin}/exp/${exp}/quiz-files` : 'quiz-files';
      let files = [];
      try {
        const r = await fetch(listUrl, { cache: 'no-store' });
        if (r.ok) {
          const data = await r.json();
          const arr = (data && Array.isArray(data.files)) ? data.files : [];
          files = arr.filter(x => typeof x === 'string' && x.toLowerCase().endsWith('.md'));
        }
      } catch {}
      if (files.length === 0) {
        // Fallback probe: try common filenames that may exist in this folder
        const candidates = ['questions.md', 'derivatives.md', 'quiz.md'];
        const found = [];
        for (const name of candidates) {
          try { const head = await fetch(name, { method:'HEAD', cache:'no-store' }); if (head.ok) found.push(name); } catch {}
        }
        files = found.length ? found : ['questions.md'];
      }
      // Populate dropdown
      quizFileSel.innerHTML = '';
      for (const f of files) {
        const opt = document.createElement('option');
        opt.value = f; opt.textContent = f.replace(/\.md$/,'');
        quizFileSel.appendChild(opt);
      }
      // Restore selection
      const saved = localStorage.getItem('looplab.quiz.file');
      if (saved && files.includes(saved)) quizFileSel.value = saved;
      QUIZ_FILE = quizFileSel.value || files[0] || 'questions.md';
    }

    // Parse markdown questions
    async function loadQuestions() {
      console.log('loadQuestions() called');
      try {
        console.log('Fetching', QUIZ_FILE, '...');
        const response = await fetch(QUIZ_FILE, { cache: 'no-store' });
        console.log('Response status:', response.status, response.ok);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const markdown = await response.text();
        console.log('Received markdown, length:', markdown.length);
        console.log('First 200 chars of markdown:', markdown.substring(0, 200));
        
        QUESTIONS = parseQuestionsEnhanced(markdown);
        console.log('Final QUESTIONS array length:', QUESTIONS.length);
      } catch (error) {
        console.error('Failed to load questions:', error);
        console.log('Using fallback hardcoded questions');
        // Fallback to hardcoded questions
        QUESTIONS = [
          { id: 'q1', text: 'Which method finds roots by halving intervals?', choices: [ 'Newton-Raphson', 'Secant', 'Bisection', 'Fixed-point' ], correct: 2 },
          { id: 'q2', text: 'Derivative of x^2 is:', choices: [ 'x', '2x', 'x^3', 'constant' ], correct: 1 },
          { id: 'q3', text: 'Matrix multiplication A(m×n)·B(n×p) yields shape:', choices: [ 'm×n', 'n×p', 'm×p', 'p×m' ], correct: 2 },
        ];
      }
    }

    // Enhanced parser: supports A) radios and A] checkboxes, ✓ correctness, skips code fences
    function parseQuestionsEnhanced(markdown) {
      const questions = [];
      const sections = markdown.split(/^## Question \d+: (\w+)/m);
      for (let i = 1; i < sections.length; i += 2) {
        const id = sections[i];
        const content = sections[i + 1] || '';
        const lines = content.trim().split('\n');
        let text = '';
        let inFence = false;
        for (const line of lines) {
          const t = line.trim();
          if (t.startsWith('```')) { inFence = !inFence; continue; }
          if (inFence) continue;
          const m = line.match(/\*\*(.*?)\*\*/);
          if (m) { text = (m[1] || '').trim(); break; }
        }
        if (!text) continue;
        const choices = [];
        const correctIdxs = [];
        let foundParen = false, foundBracket = false;
        inFence = false;
        for (const raw of lines) {
          const t = raw.trim();
          if (t.startsWith('```')) { inFence = !inFence; continue; }
          if (inFence) continue;
          let m = raw.match(/^[A-Z]\)\s*(.*?)\s*(✓)?\s*$/);
          let isMulti = false;
          if (!m) { m = raw.match(/^[A-Z]\]\s*(.*?)\s*(✓)?\s*$/); isMulti = !!m; }
          if (m) {
            const choiceText = (m[1] || '').trim();
            const hasTick = !!m[2];
            if (isMulti) foundBracket = true; else foundParen = true;
            const idx = choices.length;
            choices.push(choiceText);
            if (hasTick) correctIdxs.push(idx);
          }
        }
        const type = foundBracket ? 'multi' : (foundParen ? 'single' : 'unknown');
        if (choices.length) questions.push({ id, text, choices, type, correctIdxs });
      }
      return questions;
    }

    function render(){
      console.log('render() called with', QUESTIONS.length, 'questions');
      qsEl.innerHTML='';
      
      if (QUESTIONS.length === 0) {
        qsEl.innerHTML = '<div style="text-align:center;padding:20px;color:orange;">No questions loaded! Check console for errors.</div>';
        return;
      }
      
      QUESTIONS.forEach((q, idx)=>{
        console.log('Rendering question', idx+1, ':', q.text);
        const wrap = document.createElement('div'); wrap.className='q';
        const title = document.createElement('h3'); title.innerHTML = `${idx+1}. ` + renderMD(q.text); wrap.appendChild(title);
        if (q.type === 'multi') { const hint=document.createElement('div'); hint.className='msg'; hint.textContent='Select all that apply'; wrap.appendChild(hint); }
        const choices = document.createElement('div'); choices.className='choices';
        q.choices.forEach((c, i)=>{
          const id = `${q.id}_${i}`;
          const label = document.createElement('label'); label.className='row';
          const inputType = (q.type === 'multi') ? 'checkbox' : 'radio';
          label.innerHTML = `<input type="${inputType}" name="${q.id}${q.type==='multi'?'[]':''}" value="${i}"> <span class="md">${renderMD(c)}</span>`;
          choices.appendChild(label);
        });
        wrap.appendChild(choices);
        const row = document.createElement('div'); row.className='row'; row.style.marginTop='10px';
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Submit';
        const msg = document.createElement('span'); msg.className='msg'; msg.textContent='';
        row.appendChild(btn); row.appendChild(msg); wrap.appendChild(row);

        btn.onclick = async ()=>{
          const sid = sidEl.value.trim(); const trial = trialEl.value.trim();
          if(!sid){ msg.textContent='Enter Student ID'; msg.className='msg err'; return; }
          const quizname = (QUIZ_FILE || '').replace(/\.md$/,'');
          let payload;
          if (q.type === 'multi') {
            const sels = Array.from(wrap.querySelectorAll(`input[name="${q.id}[]"]:checked`));
            if (sels.length === 0) { msg.textContent='Select at least one option'; msg.className='msg err'; return; }
            const idxs = sels.map(el => Number(el.value));
            payload = { kind:'quiz', quizname, qid:q.id, type:'multi', question:q.text, choice_indices: idxs, choice_texts: idxs.map(j=> q.choices[j]), ts: new Date().toISOString() };
          } else {
            const sel = wrap.querySelector(`input[name="${q.id}"]:checked`);
            if(!sel){ msg.textContent='Select an option'; msg.className='msg err'; return; }
            const choiceIdx = Number(sel.value);
            payload = { kind:'quiz', quizname, qid:q.id, type:'single', question:q.text, choice_index: choiceIdx, choice_text: q.choices[choiceIdx], ts: new Date().toISOString() };
          }
          try{
            // Root /call requires experiment_name; verify against active
            let experiment_name = '';
            try { const r = await fetch(`${origin}/api/active-experiment`); if (r.ok) { const d = await r.json(); experiment_name = d.active || ''; } } catch {}
            const res = await fetch(`${origin}/call`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ student_id: sid, func_name: 'echo', args: [payload], trial: trial || undefined, experiment_name })});
            if(!res.ok){ let t=''; try{ const d = await res.json(); t = typeof d.detail==='string'? d.detail: JSON.stringify(d.detail);}catch{ try{ t = await res.text(); }catch{} } throw new Error(t||`HTTP ${res.status}`); }
            msg.textContent='Logged'; msg.className='msg ok';
          }catch(e){ msg.textContent = e.message || String(e); msg.className='msg err'; }
        };

        qsEl.appendChild(wrap);
      });
    }

    // (inline stats removed; see quiz-stats.html)

    // stats handler moved to new page link below
    // Initialize the quiz
    (async () => {
      qsEl.innerHTML = '<div style="text-align:center;padding:20px;">Loading questions...</div>';
      try {
        await loadQuizManifest();
        await loadQuestions();
        console.log('Loaded questions:', QUESTIONS);
        render();
        if ((sidEl.value || '').trim()) { checkRegistration(); }
      } catch (error) {
        console.error('Failed to initialize quiz:', error);
        qsEl.innerHTML = '<div style="text-align:center;padding:20px;color:red;">Failed to load questions. Using fallback questions.</div>';
        setTimeout(() => render(), 1000);
      }
    })();

    // React to quiz file changes
    quizFileSel.addEventListener('change', async ()=>{
      QUIZ_FILE = quizFileSel.value || 'questions.md';
      localStorage.setItem('looplab.quiz.file', QUIZ_FILE);
      qsEl.innerHTML = '<div style="text-align:center;padding:20px;">Loading questions...</div>';
      await loadQuestions();
      render();
    });

    // Open stats page for the selected quiz file
    statsBtn.addEventListener('click', ()=>{
      const quizname = (QUIZ_FILE || '').replace(/\.md$/,'');
      const trial = (trialEl.value||'').trim();
      const url = new URL('quiz-stats.html', location.href);
      url.searchParams.set('quiz', quizname);
      if (trial) url.searchParams.set('trial', trial);
      window.open(url.toString(), '_blank');
    });
  </script>
</body>
</html>
